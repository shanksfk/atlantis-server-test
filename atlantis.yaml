version: 3

projects:
  - name: "infra"
    dir: "infra-local"
    workflow: "custom"



workflows:
  custom:
    plan:
      steps:
        - run: echo "Starting custom workflow"
#        - run: |
#            echo "Initializing Terraform..."
#            terraform init
#        - run: |
#            echo "Cleaning up previous plan files..."
#            rm -f tfplan.binary tfplan.json
#        - run: |
#            echo "Generating Terraform plan in JSON format..."
#            terraform plan -out=tfplan.binary
#            terraform show -json tfplan.binary > tfplan.json
#        - run: |
#            echo "Running OPA policy checks..."
#            echo "## OPA Policy Check Results"
#
#            # Run OPA and save output
#            opa eval --format json --data policy.rego --input tfplan.json "data.terraform.analysis.violations" > opa_output.json
#
#            # Parse OPA output and generate Markdown table
#            echo "DEBUG: OPA Output Structure:"
#            cat opa_output.json
#
#            # Generate Markdown table
#            echo "Generating Markdown table..."
#            jq -r '
#              ["Resource", "Violation", "Message"] as $headers |
#              [["---", "---", "---"]] as $separator |
#              .result[].expressions[].value[]? |
#              [.resource, .violation, .message] as $row |
#              [$headers, $separator, $row] |
#              .[] | @tsv
#            ' opa_output.json | sed 's/\t/ | /g' > opa_table.md
#
#            # Add Markdown table to a comment file
#            echo -e "### OPA Policy Check Results\n" > comment.md
#            cat opa_table.md >> comment.md
#
#            # Print the comment for debugging
#            echo "Generated Comment:"
#            cat comment.md
        - run: |
            echo "Extracting GitHub Repository Details..."
            
            # Automatically extract repo owner and name from git remote
            REPO_FULL_URL=$(git config --get remote.origin.url)
            REPO_NAME=$(basename -s .git $(echo $REPO_FULL_URL | sed -E 's|.*github.com[:/](.*)|\1|'))
            REPO_OWNER=$(echo $REPO_FULL_URL | sed -E 's|.*github.com[:/]([^/]+)/.*|\1|')
            
            # Get the current Pull Request number dynamically (for GitHub Actions, Atlantis, etc.)
            echo "$PULL_REQUEST_NUMBER"
            $PR_NUMBER = 3
            
            echo "Repo Owner: $REPO_OWNER"
            echo "Repo Name: $REPO_NAME"
            echo "PR Number: $PULL_REQUEST_NUMBER"
            
        - run: |
            echo "Posting a Custom Comment to GitHub..."
            
            # Define the comment content
            COMMENT_BODY=$(cat <<EOF
            ### ðŸ“Š Custom Table Data
            ---
            | Column 1 | Column 2 | Column 3 |
            |----------|----------|----------|
            | Data A   | Data B   | Data C   |
            | Data D   | Data E   | Data F   |
            ---
            *This is an automated comment generated during Atlantis plan.*
            EOF
            )

            # Post the comment to the PR dynamically
            curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/shanksfk/atlantis-server-test/issues/3/comments" \
              -d "{\"body\": \"$COMMENT_BODY\"}"

    apply:
      steps:
        - run: |
            echo "Cleaning up any existing plan files..."
            rm -f tfplan.binary tfplan.json
        - apply