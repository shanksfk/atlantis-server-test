version: 3

projects:
  - name: "infra"
    dir: "infra-local"
    workflow: "custom"

workflows:
  custom:
    plan:
      steps:
        - run: echo "Starting custom workflow"
        - run: git --version
        - run: |
            echo "Initializing Terraform..."
            terraform init
        - run: |
            echo "Generating Terraform plan in JSON format..."
            terraform plan -out=tfplan.binary
            terraform show -json tfplan.binary > tfplan.json
        - run: |
            echo "Running OPA policy checks..."
            OPA_RESULT=$(opa eval --format json --data infra-local/policy.rego --input tfplan.json "data.terraform.analysis.violations")
            echo "$OPA_RESULT" > opa_results.json
        
            echo "Formatting OPA results into a Markdown table..."
            if [[ -s opa_results.json ]]; then
              OPA_TABLE=$(jq -r '
                .result[]?.expressions[]?.value
                | select(. != null)
                | to_entries
                | map("| \(.key + 1) | \(.value.violation_type) | \(.value.description) |")
                | join("\n")
              ' opa_results.json)
            else
              OPA_TABLE="No violations found."
            fi
        
            echo -e "## OPA Policy Check Results\n\n$OPA_TABLE" > opa_summary.md
        
            echo "Posting OPA results as a PR comment..."

    apply:
      steps:
        - apply
