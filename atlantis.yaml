version: 3

projects:
  - name: "infra"
    dir: "infra-local"
    workflow: "custom"

workflows:
  custom:
    plan:
      steps:
        - run: echo "Starting custom workflow"
        - run: git --version
        - run: |
            echo "Initializing Terraform..."
            terraform init
        - run: |
            echo "Cleaning up previous plan files..."
            rm -f tfplan.binary tfplan.json
        - run: |
            echo "Generating Terraform plan in JSON format..."
            terraform plan -out=tfplan.binary
            terraform show -json tfplan.binary > tfplan.json
        - run: |
            echo "Running OPA policy checks..."
            echo "## OPA Policy Check Results"
            
            # Run OPA and save output
            opa eval --format json --data policy.rego --input tfplan.json "data.terraform.analysis.violations" > opa_output.json
            
            echo "DEBUG: OPA Output Structure:"
            cat opa_output.json
            
            # Print table header
            echo "| # | Violation Type | Description |"
            echo "|---|---------------|-------------|"
            
            # Try simpler jq query first
            jq -r '.result[0].violations[]? | "| 1 | \(.violation_type) | \(.description) |"' opa_output.json || \
            jq -r '.result[]? | "| 1 | \(.violation_type) | \(.description) |"' opa_output.json || \
            echo "No violations found."
            
            rm -f opa_output.json
        - run: |
            echo "Cleaning up plan files..."
            rm -f tfplan.binary tfplan.json

    apply:
      steps:
        - run: |
            echo "Cleaning up any existing plan files..."
            rm -f tfplan.binary tfplan.json
        - apply